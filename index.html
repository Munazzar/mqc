<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VentScript â€“ Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- App icons (youâ€™ll create these, see SVG at bottom) -->
  <link rel="icon" type="image/svg+xml" href="ventscript-logo.svg" />
  <link rel="apple-touch-icon" href="icons/ventscript-192.png" />

  <!-- Google Fonts: cursive for headings, soft sans for body -->
  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Nunito:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Google APIs (same pattern as NoteCards) -->
  <script
    src="https://apis.google.com/js/api.js"
    async
    defer
    onload="gapiLoaded()"
  ></script>
  <script
    src="https://accounts.google.com/gsi/client"
    async
    defer
    onload="gisLoaded()"
  ></script>

  <style>
    :root {
      --bg: linear-gradient(145deg, #e0f4ff, #fff7e5);
      --bg-solid: #f5fafc;
      --bg-elevated: #fbf5ee;
      --accent: #22b5e6;
      --accent-soft: rgba(34, 181, 230, 0.12);
      --accent-strong: #f59e0b;
      --text: #083344;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --danger: #b91c1c;
      --radius-lg: 18px;
      --radius-xl: 26px;
      --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.2);
      --editor-bg: #fdf7ee;
    }

    body[data-theme="dark"] {
      --bg: radial-gradient(circle at top, #0f172a, #020617);
      --bg-solid: #020617;
      --bg-elevated: rgba(15, 23, 42, 0.98);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --accent-strong: #fb923c;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --shadow-soft: 0 26px 80px rgba(0, 0, 0, 0.8);
      --editor-bg: #020617;
    }

    * {
      box-sizing: border-box;
      transition:
        background-color 0.25s ease,
        color 0.25s ease,
        border-color 0.25s ease,
        box-shadow 0.25s ease,
        transform 0.18s ease;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      background-image: var(--bg);
      background-attachment: fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(
        90deg,
        rgba(248, 250, 252, 0.85),
        rgba(240, 249, 255, 0.9)
      );
      backdrop-filter: blur(18px);
      position: sticky;
      top: 0;
      z-index: 20;
    }
      @media (max-width: 768px) {
            header {
            flex-wrap:wrap;
            
            }
      }

    body[data-theme="dark"] header {
      background: linear-gradient(
        90deg,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.9)
      );
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: conic-gradient(
        from 160deg,
        #22b5e6,
        #f97316,
        #facc15,
        #22b5e6
      );
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.35);
      transform-origin: center;
      animation: floatIn 700ms ease-out;
    }

    .brand-logo span {
      font-family: "Pacifico", cursive;
      font-size: 20px;
      color: #f9fafb;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-family: "Pacifico", cursive;
      font-size: 22px;
      letter-spacing: 0.03em;
      color: var(--text);
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }
          @media (max-width: 768px) {
              .header-right {
                  margin-top:10px;
              }


          }
    .status-pill {
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(226, 232, 240, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
      white-space: nowrap;
    }

    body[data-theme="dark"] .status-pill {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .btn,
    .theme-toggle,
    .sidebar-toggle {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: linear-gradient(135deg, var(--accent-soft), rgba(255, 255, 255, 0.02));
      color: var(--text);
      padding: 7px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.25);
      white-space: nowrap;
    }

    .btn:hover,
    .theme-toggle:hover,
    .sidebar-toggle:hover {
      transform: translateY(-1px);
      background: linear-gradient(
        135deg,
        rgba(34, 181, 230, 0.23),
        rgba(253, 186, 116, 0.12)
      );
    }

    .btn:active,
    .theme-toggle:active,
    .sidebar-toggle:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.4);
    }

    .btn-ghost {
      border-color: var(--border);
      background: rgba(248, 250, 252, 0.9);
      box-shadow: none;
    }

    body[data-theme="dark"] .btn-ghost {
      background: rgba(15, 23, 42, 0.95);
    }

    .theme-toggle,
    .sidebar-toggle {
      border-color: var(--border);
      background: rgba(248, 250, 252, 0.9);
      box-shadow: none;
    }

    body[data-theme="dark"] .theme-toggle,
    body[data-theme="dark"] .sidebar-toggle {
      background: rgba(15, 23, 42, 0.9);
    }

    .sidebar-toggle-label {
      display: none;
    }

    @media (max-width: 768px) {
      .sidebar-toggle-label {
        display: inline;
      }
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
      gap: 18px;
      padding: 16px 16px 20px;
    }

    body.sidebar-hidden main {
      grid-template-columns: 0 minmax(0, 1fr);
    }

    body.sidebar-hidden .sidebar-card {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-24px);
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
      body.sidebar-hidden main {
        grid-template-columns: minmax(0, 1fr);
      }
      body.sidebar-hidden .sidebar-card {
        display: none;
      }
    }

    .card {
      background: var(--bg-elevated);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 10px;
      position: relative;
      overflow: hidden;
      animation: floatIn 650ms ease-out;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at top left,
        rgba(34, 181, 230, 0.12),
        transparent 60%
      );
      opacity: 0.9;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    /* Sidebar */
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    body[data-theme="dark"] .chip {
      background: rgba(15, 23, 42, 0.95);
    }

    .date-picker {
      margin-bottom: 10px;
    }

    .date-picker label {
      font-size: 12px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .date-picker input[type="date"] {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.95);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    body[data-theme="dark"] .date-picker input[type="date"] {
      background: rgba(15, 23, 42, 0.96);
    }

    .date-picker input[type="date"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 181, 230, 0.5);
    }

    .entries-list {
      margin-top: 6px;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      padding-right: 4px;
    }

    .entry-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-radius: 10px;
      margin-bottom: 3px;
      cursor: pointer;
      font-size: 13px;
      border: 1px solid transparent;
      background: transparent;
    }

    .entry-item:hover {
      background: rgba(248, 250, 252, 0.9);
      border-color: var(--border);
      transform: translateY(-1px);
    }

    body[data-theme="dark"] .entry-item:hover {
      background: rgba(15, 23, 42, 0.98);
    }

    .entry-item.active {
      background: rgba(34, 181, 230, 0.16);
      border-color: rgba(34, 181, 230, 0.65);
      box-shadow: 0 8px 22px rgba(34, 181, 230, 0.18);
    }

    .entry-main-label {
      font-weight: 600;
      max-width: 155px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .entry-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: 6px;
      white-space: nowrap;
    }

    /* Editor */
    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 8px;
    }

    .editor-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .editor-date {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-strong);
    }

    .editor-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .editor-actions {
      display: flex;
      align-items: center;
      gap: 7px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .save-status {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .save-status.error {
      color: var(--danger);
    }

    .entry-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .entry-pill {
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
      background: rgba(248, 250, 252, 0.9);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    body[data-theme="dark"] .entry-pill {
      background: rgba(15, 23, 42, 0.95);
    }

    .entry-pill.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .editor-top-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .title-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 13px;
      background: rgba(248, 250, 252, 0.95);
      color: var(--text);
      outline: none;
    }

    body[data-theme="dark"] .title-input {
      background: rgba(15, 23, 42, 0.96);
    }

    .title-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 181, 230, 0.5);
    }

    .mood-select {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.95);
      color: var(--text-muted);
      padding: 4px 8px;
      font-size: 12px;
      outline: none;
    }

    body[data-theme="dark"] .mood-select {
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-muted);
    }

    .editor-body {
      margin-top: 6px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--editor-bg);
      padding: 10px 11px;
      min-height: 260px;
      max-height: calc(100vh - 260px);
      display: flex;
      flex-direction: column;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .editor-body.full-height {
      height: calc(100vh - 170px);
      max-height: none;
    }

    @media (max-width: 800px) {
      .editor-body {
        max-height: none;
      }
      .editor-body.full-height {
        height: auto;
      }
    }

    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 4px;
    }

    .toolbar-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.9);
      padding: 3px 8px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
    }

    .toolbar-btn:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text);
    }

    .toolbar-btn.active {
      border-color: var(--accent);
      background: rgba(250, 204, 21, 0.25);
    }

    body[data-theme="dark"] .toolbar-btn {
      background: rgba(15, 23, 42, 0.96);
    }

    .editor-area {
      flex: 1;
      overflow-y: auto;
      padding-top: 4px;
    }

    .journal-editor {
      min-height: 220px;
      outline: none;
      font-size: 15px;
      line-height: 1.75;
      color: var(--text);
      font-family: "Nunito", system-ui, -apple-system, sans-serif;
    }

    .journal-editor:empty::before {
      content: attr(data-placeholder);
      color: var(--text-muted);
    }

    .editor-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
      gap: 4px;
    }

    .pill-link {
      text-decoration: underline;
      cursor: pointer;
      color: var(--accent);
    }

    /* Animations */
    @keyframes floatIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-logo">
      <span>V</span>
    </div>
    <div class="brand-text">
      <div class="brand-title">VentScript</div>
      <div class="brand-subtitle">A soft place to vent & journal</div>
    </div>
  </div>
  <div class="header-right">
    <span id="globalStatus" class="status-pill">Offline Â· not connected</span>

    <button id="sidebarToggle" class="sidebar-toggle" type="button">
      <span class="sidebar-toggle-label">Panel</span> â‡†
    </button>

    <button id="themeToggle" class="theme-toggle" type="button">
      <span id="themeLabel">Dark</span>
    </button>

    <button id="signinBtn" class="btn" type="button">Sign in</button>
    <button id="signoutBtn" class="btn btn-ghost" type="button" style="display:none;">Sign out</button>
  </div>
</header>

<main>
  <!-- SIDEBAR -->
  <section class="card sidebar-card">
    <div class="card-inner">
      <div class="sidebar-header">
        <span class="sidebar-title">Days</span>
        <span class="chip" id="entriesCount">0 days</span>
      </div>

      <div class="date-picker">
        <label for="dateInput">Jump to date</label>
        <input type="date" id="dateInput" />
      </div>

      <div class="entries-list" id="entriesList"></div>
    </div>
  </section>

  <!-- EDITOR -->
  <section class="card">
    <div class="card-inner">
      <div class="editor-header">
        <div class="editor-title-group">
          <div class="editor-date" id="editorDateLabel">Select a date to begin</div>
          <div class="editor-subtitle">Each day can hold multiple soft vents & reflections.</div>
        </div>
        <div class="editor-actions">
          <span id="saveStatus" class="save-status">Offline â€“ not saved</span>
          <button id="newTodayBtn" class="btn btn-ghost" type="button">Today</button>
          <button id="newEntryBtn" class="btn btn-ghost" type="button">New entry</button>
          <button id="saveBtn" class="btn" type="button">Save</button>
        </div>
      </div>

      <div class="entry-tabs" id="entryTabs"></div>

      <div class="editor-top-row">
        <input
          id="entryTitleInput"
          class="title-input"
          type="text"
          placeholder="Entry title (e.g., Late-night vent, Morning gratitude)"
        />
        <select id="moodSelect" class="mood-select">
          <option value="">Mood</option>
          <option value="ðŸ˜Š">ðŸ˜Š Calm</option>
          <option value="ðŸ˜„">ðŸ˜„ Energized</option>
          <option value="ðŸ˜”">ðŸ˜” Low</option>
          <option value="ðŸ˜¡">ðŸ˜¡ Frustrated</option>
          <option value="ðŸ˜´">ðŸ˜´ Tired</option>
        </select>
      </div>

      <div class="editor-body" id="editorBody">
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" data-cmd="bold"><strong>B</strong></button>
          <button type="button" class="toolbar-btn" data-cmd="italic"><em>I</em></button>
          <button type="button" class="toolbar-btn" data-cmd="underline"><u>U</u></button>
          <button
            type="button"
            class="toolbar-btn"
            data-cmd="hiliteToggle"
            data-value="#fff59d"
          >
            Highlight
          </button>
          <button
            type="button"
            class="toolbar-btn"
            data-cmd="insertUnorderedList"
          >
            â€¢ List
          </button>
          <button
            type="button"
            class="toolbar-btn"
            data-cmd="removeFormat"
          >
            Clear
          </button>
        </div>

        <div class="editor-area">
          <div
            id="journalEditor"
            class="journal-editor"
            contenteditable="true"
            data-placeholder="Spill your thoughtsâ€¦ bold them, underline them, highlight the pieces that matter."
          ></div>
        </div>

        <div class="editor-footer">
          <div>
            <span>Prompt: </span>
            <span class="pill-link" id="promptIdea">Give me something to write about</span>
          </div>
          <div id="entryMetaLabel"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  // ===== CONFIG =====
  const API_KEY = "AIzaSyCgkQ2GWpKqy-z0eZqmSA0t13QCxm5r9DY";
  const CLIENT_ID = "79019240158-qa38g7i61r4cof05k7i149gs0v2pq8ih.apps.googleusercontent.com";

  // Scopes: files you create/edit + basic file contents
  const SCOPES = "https://www.googleapis.com/auth/drive";

  const JOURNAL_FILE_NAME   = "journal.json";
  const JOURNAL_FILE_LS_KEY = "journalFileId";

  // ===== GLOBAL STATE =====
  let tokenClient;
  let gapiInited = false;
  let gisInited  = false;

  let journalFileId = "1Y3JWsc3sA-fR6tJMh9Dy9sy6CweDUJj5";
  let journalData   = { version: 1, days: [] };
  let currentDateString = null;
  let currentEntryId    = null;
  let autosaveTimer     = null;

  // DOM refs
  const globalStatusEl  = document.getElementById("globalStatus");
  const saveStatusEl    = document.getElementById("saveStatus");
  const signinBtn       = document.getElementById("signinBtn");
  const signoutBtn      = document.getElementById("signoutBtn");
  const sidebarToggle   = document.getElementById("sidebarToggle");
  const dateInput       = document.getElementById("dateInput");
  const entriesListEl   = document.getElementById("entriesList");
  const entriesCountEl  = document.getElementById("entriesCount");
  const editorDateLabel = document.getElementById("editorDateLabel");
  const entryTitleInput = document.getElementById("entryTitleInput");
  const moodSelectEl    = document.getElementById("moodSelect");
  const journalEditorEl = document.getElementById("journalEditor");
  const editorBodyEl    = document.getElementById("editorBody");
  const saveBtn         = document.getElementById("saveBtn");
  const newTodayBtn     = document.getElementById("newTodayBtn");
  const newEntryBtn     = document.getElementById("newEntryBtn");
  const promptIdeaLink  = document.getElementById("promptIdea");
  const entryTabsEl     = document.getElementById("entryTabs");
  const entryMetaLabel  = document.getElementById("entryMetaLabel");
  const themeToggleBtn  = document.getElementById("themeToggle");
  const themeLabel      = document.getElementById("themeLabel");

  // ==== UTIL ====
  function setGlobalStatus(text, online) {
    globalStatusEl.textContent = text;
    if (online) {
      globalStatusEl.style.background  = "rgba(187, 247, 208, 0.55)";
      globalStatusEl.style.borderColor = "rgba(34, 197, 94, 0.9)";
      globalStatusEl.style.color       = "#166534";
    } else {
      globalStatusEl.style.background  = "";
      globalStatusEl.style.borderColor = "";
      globalStatusEl.style.color       = "";
    }
  }

  function setSaveStatus(text, isError = false) {
    saveStatusEl.textContent = text;
    saveStatusEl.classList.toggle("error", !!isError);
  }

  function toISODateString(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function formatDisplayDate(dateString) {
    const [y, m, d] = dateString.split("-");
    const dt = new Date(Number(y), Number(m) - 1, Number(d));
    return dt.toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric",
      year: "numeric"
    });
  }

  function applyTheme(theme) {
    document.body.setAttribute("data-theme", theme);
    // Label shows the *other* mode
    themeLabel.textContent = theme === "dark" ? "Light" : "Dark";
    localStorage.setItem("journalTheme", theme);
  }

  function toggleTheme() {
    const current = document.body.getAttribute("data-theme") || "light";
    const next = current === "light" ? "dark" : "light";
    applyTheme(next);
  }

  // ===== GOOGLE INIT =====
  async function initGapiClient() {
    try {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
      });
      gapiInited = true;
      maybeAutoSignIn();
    } catch (err) {
      console.error(err);
      setGlobalStatus("Error initializing Google client", false);
    }
  }

  // called by script tag
  function gapiLoaded() {
    if (window.gapi && gapi.load) {
      gapi.load("client", initGapiClient);
    }
  }

  // called by script tag
  function gisLoaded() {
    if (!window.google || !google.accounts) return;
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: () => {}
    });
    gisInited = true;
    maybeAutoSignIn();
  }

  function maybeAutoSignIn() {
    if (!gapiInited || !gisInited) return;

    const stored = JSON.parse(localStorage.getItem("journalAuthToken") || "null");
    const now    = Date.now();

    if (stored && stored.access_token && stored.expires_at && stored.expires_at > now) {
      gapi.client.setToken({ access_token: stored.access_token });
      onSignedIn();
      return;
    }

    tokenClient.callback = (resp) => {
      if (resp.error) {
        console.log("Silent token not available yet");
        setGlobalStatus("Offline Â· sign in to save", false);
        setSaveStatus("Offline â€“ journal not synced");
        return;
      }
      const expiresAt = Date.now() + (resp.expires_in * 1000 - 60_000);
      localStorage.setItem("journalAuthToken", JSON.stringify({
        access_token: resp.access_token,
        expires_at: expiresAt
      }));
      gapi.client.setToken(resp);
      onSignedIn();
    };

    tokenClient.requestAccessToken({ prompt: "" });
  }

  function handleSignIn() {
    if (!gapiInited || !gisInited) {
      alert("Google libraries not ready yet. Please wait a moment and try again.");
      return;
    }

    tokenClient.callback = (resp) => {
      if (resp.error) {
        console.error(resp);
        setGlobalStatus("Sign-in failed", false);
        return;
      }
      const expiresAt = Date.now() + (resp.expires_in * 1000 - 60_000);
      localStorage.setItem("journalAuthToken", JSON.stringify({
        access_token: resp.access_token,
        expires_at: expiresAt
      }));
      gapi.client.setToken(resp);
      onSignedIn();
    };

    tokenClient.requestAccessToken({ prompt: "consent" });
  }

  function handleSignOut() {
    if (typeof gapi !== "undefined" && gapi.client && gapi.client.getToken) {
      const token = gapi.client.getToken();
      if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken(null);
      }
    }
    localStorage.removeItem("journalAuthToken");
    localStorage.removeItem(JOURNAL_FILE_LS_KEY);

    journalFileId      = null;
    journalData        = { version: 1, days: [] };
    currentDateString  = null;
    currentEntryId     = null;

    entriesListEl.innerHTML = "";
    entriesCountEl.textContent = "0 days";
    editorDateLabel.textContent = "Select a date to begin";
    entryTitleInput.value = "";
    moodSelectEl.value = "";
    journalEditorEl.innerHTML = "";
    entryTabsEl.innerHTML = "";
    entryMetaLabel.textContent = "";
    editorBodyEl.classList.remove("full-height");
    setSaveStatus("Offline â€“ not saved");
    setGlobalStatus("Offline Â· not connected", false);
    signinBtn.style.display = "inline-flex";
    signoutBtn.style.display = "none";
  }

  async function onSignedIn() {
    setGlobalStatus("Online Â· connected", true);
    signinBtn.style.display  = "inline-flex";
    signoutBtn.style.display = "inline-flex";
    setSaveStatus("Ready â€“ saving to journal.json");

    try {
      journalFileId = await ensureJournalFile();
      journalData   = await loadJournalDataFromDrive();
      renderDaysList();

      const today = toISODateString(new Date());
      dateInput.value = today;
      openDay(today);
    } catch (err) {
      console.error(err);
      setSaveStatus("Error loading journal.json", true);
    }
  }

  // ===== DRIVE HELPERS (single journal.json) =====
  async function ensureJournalFile() {
    const cachedId = localStorage.getItem(JOURNAL_FILE_LS_KEY);
    if (cachedId) {
      try {
        const res = await gapi.client.drive.files.get({
          fileId: cachedId,
          fields: "id, trashed"
        });
        if (!res.result.trashed) {
          return cachedId;
        }
      } catch (e) {
        console.warn("Cached journal file not found, searching by name");
      }
    }

    const listRes = await gapi.client.drive.files.list({
      q: `name='${JOURNAL_FILE_NAME}' and trashed=false`,
      fields: "files(id, name)",
      spaces: "drive",
      pageSize: 1
    });

    if (listRes.result.files && listRes.result.files.length > 0) {
      const id = listRes.result.files[0].id;
      localStorage.setItem(JOURNAL_FILE_LS_KEY, id);
      return id;
    }

    // create new file
    const createRes = await gapi.client.drive.files.create({
      resource: {
        name: JOURNAL_FILE_NAME,
        mimeType: "application/json"
      },
      fields: "id"
    });

    const id = createRes.result.id;

    await gapi.client.request({
      path: `/upload/drive/v3/files/${id}`,
      method: "PATCH",
      params: { uploadType: "media" },
      body: JSON.stringify({ version: 1, days: [] })
    });

    localStorage.setItem(JOURNAL_FILE_LS_KEY, id);
    return id;
  }

  async function loadJournalDataFromDrive() {
    if (!journalFileId) return { version: 1, days: [] };

    const res = await gapi.client.request({
      path: `/drive/v3/files/${journalFileId}`,
      method: "GET",
      params: { alt: "media" }
    });

    let data = null;
    try {
      data = JSON.parse(res.body);
    } catch (e) {
      console.warn("journal.json invalid JSON, resetting", e);
    }

    if (!data || !Array.isArray(data.days)) {
      data = { version: 1, days: [] };
    }

    return data;
  }

  async function saveJournalDataToDrive() {
    if (!journalFileId) return;
    await gapi.client.request({
      path: `/upload/drive/v3/files/${journalFileId}`,
      method: "PATCH",
      params: { uploadType: "media" },
      body: JSON.stringify(journalData)
    });
  }

  // ===== JOURNAL MODEL HELPERS =====
  function getOrCreateDay(dateString) {
    let day = journalData.days.find((d) => d.date === dateString);
    if (!day) {
      day = { date: dateString, entries: [] };
      journalData.days.push(day);
    }
    return day;
  }

  function createEntryObject() {
    const nowIso = new Date().toISOString();
    return {
      id: String(Date.now()) + "-" + Math.random().toString(36).slice(2, 8),
      title: "",
      html: "",
      mood: "",
      createdAt: nowIso,
      updatedAt: nowIso
    };
  }

  function getCurrentDay() {
    if (!currentDateString) return null;
    return journalData.days.find((d) => d.date === currentDateString) || null;
  }

  function getCurrentEntry() {
    const day = getCurrentDay();
    if (!day) return null;
    return day.entries.find((e) => e.id === currentEntryId) || null;
  }

  function renderDaysList() {
    const daysSorted = [...journalData.days].sort((a, b) => a.date.localeCompare(b.date));
    entriesListEl.innerHTML = "";
    entriesCountEl.textContent =
      `${daysSorted.length} ${daysSorted.length === 1 ? "day" : "days"}`;

    daysSorted.forEach((day) => {
      const item = document.createElement("div");
      item.className = "entry-item";
      item.dataset.date = day.date;

      const label = document.createElement("div");
      label.className = "entry-main-label";
      label.textContent = formatDisplayDate(day.date);

      const meta = document.createElement("div");
      meta.className = "entry-meta";
      meta.textContent = `${day.entries.length} entr${day.entries.length === 1 ? "y" : "ies"}`;

      item.appendChild(label);
      item.appendChild(meta);

      item.addEventListener("click", () => {
        dateInput.value = day.date;
        openDay(day.date);
      });

      entriesListEl.appendChild(item);
    });

    highlightActiveDay();
  }

  function highlightActiveDay() {
    const children = [...entriesListEl.children];
    children.forEach((el) => {
      el.classList.toggle("active", el.dataset.date === currentDateString);
    });
  }

  function renderEntryTabs() {
    entryTabsEl.innerHTML = "";
    const day = getCurrentDay();
    if (!day) return;

    day.entries.forEach((entry, idx) => {
      const pill = document.createElement("button");
      pill.type = "button";
      pill.className = "entry-pill";
      pill.dataset.id = entry.id;
      pill.textContent = entry.title || `Entry ${idx + 1}`;

      if (entry.id === currentEntryId) {
        pill.classList.add("active");
      }

      pill.addEventListener("click", () => {
        saveEntryFromEditorToState();
        currentEntryId = entry.id;
        editorBodyEl.classList.remove("full-height");
        loadCurrentEntryIntoEditor();
        renderEntryTabs();
      });

      entryTabsEl.appendChild(pill);
    });
  }

  function loadCurrentEntryIntoEditor() {
    const entry = getCurrentEntry();
    if (!entry) {
      entryTitleInput.value = "";
      moodSelectEl.value   = "";
      journalEditorEl.innerHTML = "";
      entryMetaLabel.textContent = "";
      return;
    }
    entryTitleInput.value = entry.title || "";
    moodSelectEl.value    = entry.mood || "";
    journalEditorEl.innerHTML = entry.html || "";

    const created = new Date(entry.createdAt);
    const updated = new Date(entry.updatedAt);
    entryMetaLabel.textContent =
      `Created ${created.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}` +
      ` Â· Last updated ${updated.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
  }

  function saveEntryFromEditorToState() {
    const day = getCurrentDay();
    if (!day || !currentEntryId) return;
    const entry = day.entries.find((e) => e.id === currentEntryId);
    if (!entry) return;

    entry.title = entryTitleInput.value.trim();
    entry.mood  = moodSelectEl.value;
    entry.html  = journalEditorEl.innerHTML;
    entry.updatedAt = new Date().toISOString();
  }

  function openDay(dateString) {
    currentDateString = dateString;
    editorDateLabel.textContent = formatDisplayDate(dateString);
    editorBodyEl.classList.remove("full-height");

    const day = getOrCreateDay(dateString);

    if (!day.entries || day.entries.length === 0) {
      const entry = createEntryObject();
      day.entries.push(entry);
      currentEntryId = entry.id;
      editorBodyEl.classList.add("full-height");
    } else {
      currentEntryId = day.entries[0].id;
    }

    renderDaysList();
    renderEntryTabs();
    loadCurrentEntryIntoEditor();
    highlightActiveDay();
    setSaveStatus("Ready â€“ changes will be saved to journal.json");
  }

  async function saveCurrentDay() {
    if (!currentDateString) return;

    const hasDriveToken =
      typeof gapi !== "undefined" &&
      gapi.client &&
      typeof gapi.client.getToken === "function" &&
      gapi.client.getToken();

    if (!hasDriveToken) {
      alert("Please sign in with Google so I can save to your Drive.");
      setSaveStatus("Offline â€“ not saved", true);
      return;
    }

    saveEntryFromEditorToState();
    setSaveStatus("Saving...");

    try {
      await saveJournalDataToDrive();
      setSaveStatus("Saved to journal.json");
      renderDaysList();
      highlightActiveDay();
    } catch (err) {
      console.error(err);
      setSaveStatus("Save failed", true);
    }
  }

  function scheduleAutosave() {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      saveCurrentDay();
    }, 8000);
  }

  // ===== RICH TEXT TOOLBAR (with highlight toggle) =====
  function handleToolbarClick(e) {
    const btn = e.target.closest(".toolbar-btn");
    if (!btn) return;

    const cmd = btn.dataset.cmd;
    const val = btn.dataset.value || null;

    // Toggle highlight separately so itâ€™s reversible
    if (cmd === "hiliteToggle") {
      journalEditorEl.focus();

      // Try to detect current highlight color
      let current = null;
      try {
        current = document.queryCommandValue("hiliteColor");
      } catch (_) {}

      const isHighlighted =
        current &&
        (current.toLowerCase() === "rgb(255, 245, 157)" ||
         current.toLowerCase() === "#fff59d");

      if (isHighlighted) {
        document.execCommand("hiliteColor", false, "transparent");
        btn.classList.remove("active");
      } else {
        document.execCommand("hiliteColor", false, val || "#fff59d");
        btn.classList.add("active");
      }

      scheduleAutosave();
      return;
    }

    journalEditorEl.focus();
    document.execCommand(cmd, false, val);

    if (cmd === "removeFormat") {
      const highlightBtn = document.querySelector('[data-cmd="hiliteToggle"]');
      if (highlightBtn) highlightBtn.classList.remove("active");
    }

    scheduleAutosave();
  }

  // ===== PROMPTS =====
  const prompts = [
    "What is one thing you wish you could say out loud but canâ€™t?",
    "What drained your energy today, and what gently filled it back up?",
    "If your mood had a weather forecast right now, what would it be?",
    "Write a letter to yourself five years ago about what youâ€™ve survived.",
    "What are three tiny wins from today, even if they feel silly?"
  ];

  function injectRandomPrompt() {
    const p = prompts[Math.floor(Math.random() * prompts.length)];
    if (!journalEditorEl.innerText.trim()) {
      journalEditorEl.innerHTML = `<p>${p}</p><p><br></p>`;
    } else {
      journalEditorEl.innerHTML += `<p><br></p><p>${p}</p>`;
    }
    journalEditorEl.focus();
    scheduleAutosave();
  }

  // ===== PWA: register service worker =====
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./service-worker.js")
        .catch((err) => console.warn("SW registration failed", err));
    });
  }

  // ===== DOM READY =====
  document.addEventListener("DOMContentLoaded", () => {
    // Theme init
    const storedTheme = localStorage.getItem("journalTheme") || "light";
    applyTheme(storedTheme);

    themeToggleBtn.addEventListener("click", toggleTheme);

    // Sidebar toggle
    sidebarToggle.addEventListener("click", () => {
      document.body.classList.toggle("sidebar-hidden");
    });

    // Basic local init for today (no gapi calls)
    const today = toISODateString(new Date());
    dateInput.value = today;
    openDay(today);

    // Auth buttons
    signinBtn.addEventListener("click", handleSignIn);
    signoutBtn.addEventListener("click", handleSignOut);

    // Date picker
    dateInput.addEventListener("change", (e) => {
      if (!e.target.value) return;
      openDay(e.target.value);
    });

    newTodayBtn.addEventListener("click", () => {
      const today = toISODateString(new Date());
      dateInput.value = today;
      openDay(today);
    });

    newEntryBtn.addEventListener("click", () => {
      if (!currentDateString) {
        const today = toISODateString(new Date());
        currentDateString = today;
        dateInput.value   = today;
        editorDateLabel.textContent = formatDisplayDate(today);
      }
      const day = getOrCreateDay(currentDateString);
      saveEntryFromEditorToState();
      const newEntry = createEntryObject();
      day.entries.push(newEntry);
      currentEntryId = newEntry.id;
      editorBodyEl.classList.add("full-height");
      loadCurrentEntryIntoEditor();
      renderEntryTabs();
      renderDaysList();
      scheduleAutosave();
    });

    saveBtn.addEventListener("click", saveCurrentDay);

    // Editor events
    journalEditorEl.addEventListener("input", () => {
      setSaveStatus("Editingâ€¦ autosave soon");
      scheduleAutosave();
    });
    entryTitleInput.addEventListener("input", () => {
      scheduleAutosave();
    });
    moodSelectEl.addEventListener("change", () => {
      scheduleAutosave();
    });

    document
      .querySelector(".editor-toolbar")
      .addEventListener("click", handleToolbarClick);

    promptIdeaLink.addEventListener("click", injectRandomPrompt);
  });
</script>
</body>
</html>
